<!--
PennHub - Single-file web app (index.html)

Instructions (read before using):
1) Cloudinary: You already provided CLOUD_NAME = "dmxcrna8k" and UPLOAD_PRESET = "ml_default"; this file assumes that preset is an unsigned upload preset that stores uploads in a folder. If you want signed uploads, change the code and use a short backend to sign.

2) Supabase (for persistence of gallery + likes):
   - Create a free project at https://supabase.com
   - From the project dashboard copy the **Project URL** and **anon/public API key** and paste them into the placeholders below (SUPABASE_URL, SUPABASE_ANON_KEY).
   - Run this SQL in Supabase -> SQL Editor to create the images table:

     -- SQL to create table
     create table public.images (
       id uuid primary key default uuid_generate_v4(),
       url text not null,
       caption text,
       likes int default 0,
       created_at timestamptz default now()
     );

   - To enable uuid_generate_v4() you may need to run: create extension if not exists "uuid-ossp"; (or use gen_random_uuid() depending on your DB extensions)

   - For quick testing you can set the table to be publicly readable and insertable from the client, but for production you should enable Row Level Security (RLS) and add appropriate policies. Example permissive policy (NOT for production):

     -- permissive insert/update policy (for testing only)
     alter table public.images enable row level security;
     create policy "allow_public_insert" on public.images for insert using (true);
     create policy "allow_public_select" on public.images for select using (true);
     create policy "allow_public_update" on public.images for update using (true);

   - For a safer setup, require authentication for inserts/updates and allow public select.

3) Deploy:
   - Put this file as index.html in the root of a GitHub repo named `pennhub` (or similar).
   - Enable GitHub Pages from the repository settings (branch: main, folder: /root).

4) What the app does:
   - Drag & drop + file picker upload to Cloudinary (your Cloudinary creds used).
   - After Cloudinary returns a secure_url, the app inserts a record into Supabase table `images` with url and timestamp.
   - On load the app fetches images from Supabase and displays them sorted by (likes desc, created_at desc).
   - Users can like an image; likes are persisted to Supabase and update in real time via polling (or you can enable real-time features from Supabase and adapt later).

5) Replace the SUPABASE_URL and SUPABASE_ANON_KEY placeholders below with your Supabase values before deploying.

-- End of instructions
--
--> 

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PennHub</title>
  <link rel="icon" type="image/png" href="pennhub.png">
  <meta name="description" content="The mostist sillist silly site of all" />
  <style>
    :root{--accent:#ff8800;--bg:#0f0f10;--fg:#e6e6e6;--card:#161616;--muted:#a0a0a0}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#0b0b0c, #121212);color:var(--fg);font-family:Inter,ui-sans-serif,system-ui,Helvetica,Arial;padding:20px;display:flex;flex-direction:column;align-items:center}
    header{width:100%;max-width:1100px;display:flex;align-items:center;gap:16px}
    h1{color:var(--accent);margin:0;font-size:1.6rem}
    .sub{color:var(--muted);margin:0}
    #uploader{width:100%;max-width:1100px;margin-top:18px;display:flex;gap:16px;align-items:center}
    .dropzone{flex:1;min-height:120px;border-radius:12px;background:linear-gradient(180deg,rgba(255,136,0,0.04),transparent);border:1px dashed rgba(255,136,0,0.12);display:flex;align-items:center;justify-content:center;padding:16px;cursor:pointer}
    .controls{display:flex;flex-direction:column;gap:8px}
    button{background:var(--accent);border:none;color:#000;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    #gallery{width:100%;max-width:1100px;margin-top:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .card{background:var(--card);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
    .imgwrap{position:relative;padding-top:66%;background:#0a0a0a}
    .imgwrap img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .meta{padding:12px;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .meta .left{display:flex;flex-direction:column}
    .meta .time{color:var(--muted);font-size:0.85rem}
    .likebar{display:flex;align-items:center;gap:8px}
    .likebtn{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
    .likecount{font-weight:700}
    .topcontrols{display:flex;gap:8px;align-items:center}
    .search{background:#0b0b0b;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:var(--fg)}
    footer{margin-top:30px;color:var(--muted)}
    @media(max-width:600px){h1{font-size:1.2rem}}
  </style>
</head>
<body>
  <header>
    <h1>PennHub</h1>
    <div style="flex:1">
      <p class="sub">Upload. Like. Share. The mostist sillist silly site of all.</p>
    </div>
    <div class="topcontrols">
      <input id="search" class="search" placeholder="Search captions..." />
    </div>
  </header>

  <section id="uploader">
    <div id="dropzone" class="dropzone">Drag & drop images here or click to choose</div>
    <div class="controls">
      <input id="fileInput" type="file" accept="image/*" style="display:none" multiple />
      <button id="pickBtn">Choose Files</button>
      <label style="font-size:0.9rem;color:var(--muted)">Max file size: 10MB. Keep it friendly.</label>
    </div>
  </section>

  <section id="gallery"></section>

  <footer>© 2025 PennHub</footer>

  <!-- External libs: Cloudinary used via direct REST POST; Supabase JS for DB interactions -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ---------- CONFIG - replace placeholders ----------
    const CLOUD_NAME = "dmxcrna8k"; // provided
    const UPLOAD_PRESET = "ml_default"; // provided unsigned preset

    // Supabase: create a free project and paste your values here
    const SUPABASE_URL = "https://zullebqesybhnkguhgkl.supabase.co"; // e.g. https://abcd1234.supabase.co
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1bGxlYnFlc3liaG5rZ3VoZ2tsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNTAwMjgsImV4cCI6MjA3NjgyNjAyOH0.yUE_xgLtyRgCu-BRSGh6aI8bBVl7u-JfF9pi3gtS7mk";

    // ---------- END CONFIG ----------

    // init Supabase client
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const pickBtn = document.getElementById('pickBtn');
    const gallery = document.getElementById('gallery');
    const search = document.getElementById('search');

    // helpers
    function humanTime(ts) {
      const d = new Date(ts);
      return d.toLocaleString();
    }

    // Fetch gallery (sorted by likes desc, then newest)
    async function fetchGallery(query = ""){
      gallery.innerHTML = '<p style="color:var(--muted)">Loading...</p>';
      let q = supabase.from('images').select('*').order('likes',{ascending:false}).order('created_at',{ascending:false});
      if(query) q = q.ilike('caption', `%${query}%`);
      const { data, error } = await q;
      if(error){
        gallery.innerHTML = `<p style="color:var(--muted)">Error loading: ${error.message}</p>`;
        return;
      }
      renderGallery(data || []);
    }

    function renderGallery(items){
      if(!items || items.length===0){ gallery.innerHTML = '<p style="color:var(--muted)">No images yet — be the first!</p>'; return; }
      gallery.innerHTML = '';
      items.forEach(it => {
        const card = document.createElement('div'); card.className='card';
        const imgwrap = document.createElement('div'); imgwrap.className='imgwrap';
        const img = document.createElement('img'); img.src = it.url; img.alt = it.caption || 'PennHub image';
        imgwrap.appendChild(img);
        const meta = document.createElement('div'); meta.className='meta';
        const left = document.createElement('div'); left.className='left';
        const time = document.createElement('div'); time.className='time'; time.textContent = humanTime(it.created_at);
        if(it.caption) {
          const cap = document.createElement('div'); cap.style.marginBottom='6px'; cap.textContent = it.caption; left.appendChild(cap);
        }
        left.appendChild(time);
        const right = document.createElement('div'); right.className='likebar';
        const likebtn = document.createElement('button'); likebtn.className='likebtn'; likebtn.innerHTML = '❤️ <span class="likecount">'+ (it.likes||0) +'</span>';
        likebtn.onclick = () => handleLike(it.id, likebtn);
        right.appendChild(likebtn);
        meta.appendChild(left); meta.appendChild(right);
        card.appendChild(imgwrap); card.appendChild(meta);
        gallery.appendChild(card);
      });
    }

    // Like handler: increments likes in DB
    async function handleLike(id, btn){
      // optimistic UI: increment locally
      const span = btn.querySelector('.likecount');
      const prev = parseInt(span.textContent||'0',10);
      span.textContent = prev + 1;

      // update DB (atomic increment)
      const { data, error } = await supabase.rpc('increment_image_likes', { image_id: id });
      if(error){
        // revert on error
        span.textContent = prev;
        console.error('Like failed', error);
        alert('Could not like — try again');
      } else {
        // success: optionally do nothing, fetch later will reconcile
      }
    }

    // Drag & drop
    ;['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.style.borderColor='rgba(255,136,0,0.6)'; }));
    ;['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.style.borderColor='rgba(255,136,0,0.12)'; }));

    dropzone.addEventListener('drop', async (e)=>{
      const files = Array.from(e.dataTransfer.files || []);
      await handleFiles(files);
    });

    dropzone.addEventListener('click', ()=>fileInput.click());
    pickBtn.addEventListener('click', ()=>fileInput.click());
    fileInput.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files || []);
      await handleFiles(files);
    });

    async function handleFiles(files){
      for(const file of files){
        if(!file.type.startsWith('image/')) continue;
        if(file.size > 10 * 1024 * 1024){ alert('File too big (max 10MB)'); continue; }
        // ask for optional caption
        const caption = prompt('Add a caption for this image (optional)') || null;
        try{
          const url = await uploadToCloudinary(file);
          // insert to supabase
          const { data, error } = await supabase.from('images').insert({ url, caption }).select().single();
          if(error) { console.error('DB insert failed', error); alert('Upload succeeded but saving metadata failed'); }
          await fetchGallery(search.value.trim());
        }catch(err){ console.error(err); alert('Upload failed'); }
      }
    }

    // Cloudinary unsigned upload
    async function uploadToCloudinary(file){
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method:'POST', body:fd });
      if(!res.ok) throw new Error('Cloudinary upload failed');
      const json = await res.json();
      return json.secure_url;
    }

    // Create Supabase RPC function for atomic increment (run this SQL in SQL editor once):
    /*
    create or replace function public.increment_image_likes(image_id uuid)
    returns void as $$
    begin
      update public.images set likes = likes + 1 where id = image_id;
    end;
    $$ language plpgsql;
    */

    // initial load
    fetchGallery();

    // search
    let searchTimer = null;
    search.addEventListener('input', ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=>fetchGallery(search.value.trim()), 350);
    });

    // optional: poll for updates every 15s (or use supabase realtime instead)
    setInterval(()=>fetchGallery(search.value.trim()), 15000);
  </script>
</body>
</html>
